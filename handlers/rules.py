from aiogram import F, Router, types
from keyboards.rules import generate_rules, generate_prohibited_kb, generate_allowed_kb
from config import PROHIBITED_KEYWORDS, ALLOWED_KEYWORDS, BOXES, MANAGER_PHONE, MANAGER_TG_ID
from aiogram.types import CallbackQuery
from handlers.box import RentBox

router = Router()


@router.message(F.text == "–ü—Ä–∞–≤–∏–ª–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è")
async def rule(message: types.Message):
    text = (
        "–ü—Ä–∞–≤–∏–ª–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –∫—Ä–∞—Ç–∫–æ –∏ –≤–∞–∂–Ω–æ:\n\n"
        "–†–∞–∑—Ä–µ—à–µ–Ω–æ:\n"
        "- –ú–µ–±–µ–ª—å, –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ (–æ–±–µ–∑–≤–æ–∂–µ–Ω–Ω–∞—è/–æ–±–µ—Å—Ç–æ—á–µ–Ω–Ω–∞—è), –æ–¥–µ–∂–¥–∞, –∫–æ—Ä–æ–±–∫–∏, –∫–Ω–∏–≥–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã,\n"
        "- –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (–ª—ã–∂–∏, —Å–Ω–æ—É–±–æ—Ä–¥, –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã), –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —É–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.\n\n"
        "–ó–∞–ø—Ä–µ—â–µ–Ω–æ:\n"
        "- –ì–æ—Ä—é—á–∏–µ –∏ –ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∏–µ—Å—è –∂–∏–¥–∫–æ—Å—Ç–∏ (–±–µ–Ω–∑–∏–Ω, —Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª–∏, –ª–∞–∫), –≥–∞–∑–æ–≤—ã–µ –±–∞–ª–ª–æ–Ω—ã,\n"
        "- –Ø–¥–æ–≤–∏—Ç—ã–µ, –∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω—ã–µ –∏ —Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞, –∂–∏–≤—ã–µ –∂–∏–≤–æ—Ç–Ω—ã–µ,\n"
        "- –í–µ—â–µ—Å—Ç–≤–∞, —Ç—Ä–µ–±—É—é—â–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π —Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ö–æ–ª–æ–¥–∏–ª—å–Ω–æ–µ, —Ö–∏–º–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ).\n\n"
        "–£—Å–ª–æ–≤–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:\n"
        "- –°—É—Ö–æ–µ, –≤–µ–Ω—Ç–∏–ª–∏—Ä—É–µ–º–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ; —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ +5‚Ä¶+25¬∞C;\n"
        "- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ 60% (–∏–∑–±–µ–≥–∞–π—Ç–µ —Å—ã—Ä–æ—Å—Ç–∏);\n"
        "- –≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–∏–±–æ—Ä—ã ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é (—Å–ª–∏–≤–∞—Ç—å —Ç–æ–ø–ª–∏–≤–æ, –æ—Ç—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã).\n\n"
        "FAQ ‚Äî –º–æ–∂–Ω–æ –ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –∂–∏–¥–∫–æ—Å—Ç–∏?\n"
        "- –ù–µ–±–æ–ª—å—à–∏–µ –±—ã—Ç–æ–≤—ã–µ –≥–µ—Ä–º–µ—Ç–∏—á–Ω—ã–µ –µ–º–∫–æ—Å—Ç–∏ (–≤–æ–¥–∞ –≤ –ø–ª–æ—Ç–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ–π —Ç–∞—Ä–µ) –æ–±—ã—á–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã.\n"
        "- –ì–æ—Ä—é—á–∏–µ, —Ç–æ–∫—Å–∏—á–Ω—ã–µ –∏–ª–∏ –∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω—ã–µ –∂–∏–¥–∫–æ—Å—Ç–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äî –∏—Ö —Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–ø–∞—Å–Ω–æ.\n\n"
        "–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–±–µ–Ω–∑–∏–Ω¬ª, ¬´–¥–∏–≤–∞–Ω¬ª, ¬´–ª—ã–∂–∏¬ª)."
    )
    await message.answer(text, reply_markup=generate_rules())


@router.message(RentBox.volume)
async def check_item(message: types.Message):
    text = message.text.lower()
    prohibited_found = [kw for kw in PROHIBITED_KEYWORDS if kw.lower() in text]
    if prohibited_found:
        reasons = {
            "–±–µ–Ω–∑–∏–Ω": "–≥–æ—Ä—é—á–∞—è –∂–∏–¥–∫–æ—Å—Ç—å, –ø–æ–∂–∞—Ä–æ–æ–ø–∞—Å–Ω–æ",
            "–¥–∏–∑–µ–ª—å": "–≥–æ—Ä—é—á–∞—è –∂–∏–¥–∫–æ—Å—Ç—å, –ø–æ–∂–∞—Ä–æ–æ–ø–∞—Å–Ω–æ",
            "—Å–æ–ª—è—Ä–∫–∞": "–≥–æ—Ä—é—á–∞—è –∂–∏–¥–∫–æ—Å—Ç—å, –ø–æ–∂–∞—Ä–æ–æ–ø–∞—Å–Ω–æ",
            "–∫–µ—Ä–æ—Å–∏–Ω": "–≥–æ—Ä—é—á–∞—è –∂–∏–¥–∫–æ—Å—Ç—å, –ø–æ–∂–∞—Ä–æ–æ–ø–∞—Å–Ω–æ",
            "—Ä–∞—Å—Ç–≤–æ—Ä–∏—Ç–µ–ª—å": "–ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∞—è—Å—è –∂–∏–¥–∫–æ—Å—Ç—å",
            "–ª–∞–∫": "–ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∞—è—Å—è –∂–∏–¥–∫–æ—Å—Ç—å",
            "–∫—Ä–∞—Å–∫–∞": "–ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∞—è—Å—è –∂–∏–¥–∫–æ—Å—Ç—å",
            "–≥–∞–∑–æ–≤—ã–π –±–∞–ª–ª–æ–Ω": "–≤–∑—Ä—ã–≤–æ–æ–ø–∞—Å–Ω–æ",
            "–±–∞–ª–ª–æ–Ω": "–≤–∑—Ä—ã–≤–æ–æ–ø–∞—Å–Ω–æ",
            "–≤–∑—Ä—ã–≤—á–∞—Ç": "–≤–∑—Ä—ã–≤–æ–æ–ø–∞—Å–Ω–æ",
            "—è–¥": "—è–¥–æ–≤–∏—Ç–æ",
            "—è–¥–æ–≤–∏—Ç": "—è–¥–æ–≤–∏—Ç–æ",
            "—Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤": "—Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω–æ",
            "—Ä–∞–¥–∏–∞—Ü–∏—è": "—Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω–æ",
            "—Ö–ª–æ—Ä": "–∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω–æ –∏ —Ç–æ–∫—Å–∏—á–Ω–æ",
            "–∫–∏—Å–ª–æ—Ç–∞": "–∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω–æ",
            "—â–µ–ª–æ—á—å": "–∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω–æ",
            "–∫–æ—Ä—Ä–æ–∑": "–∫–æ—Ä—Ä–æ–∑–∏–æ–Ω–Ω–æ",
            "–∂–∏–≤–æ—Ç": "–∂–∏–≤—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–º—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã",
            "–∂–∏–≤—ã–µ": "–∂–∏–≤—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–º—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã",
            "–æ—Ä–≥–∞–Ω–∏–∫–∞ (–≥–Ω–∏–ª–æ—Å—Ç–Ω–∞—è)": "–≥–Ω–∏–ª–æ—Å—Ç–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∫–∞",
            "–ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∏–µ—Å—è": "–ª–µ–≥–∫–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è—é—â–∏–µ—Å—è –≤–µ—â–µ—Å—Ç–≤–∞",
            "–æ–≥–Ω–µ–æ–ø–∞—Å–Ω–æ": "–æ–≥–Ω–µ–æ–ø–∞—Å–Ω–æ"
        }
        reason = reasons.get(prohibited_found[0], "–∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
        await message.answer(
            f"–≠—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç –∑–∞–ø—Ä–µ—â—ë–Ω –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é –ø–æ –ø—Ä–∏—á–∏–Ω–µ: {reason}. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã: —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º.",
            reply_markup=generate_prohibited_kb()
        )
        return

    allowed_found = [kw for kw in ALLOWED_KEYWORDS if kw.lower() in text]
    if allowed_found:
        await message.answer(
            "–≠—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é. –•–æ—Ç–∏—Ç–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –±–æ–∫—Å?",
            reply_markup=generate_allowed_kb()
        )
        return
    
    await message.answer(
        "–ù–µ —É–≤–µ—Ä–µ–Ω, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.",
        reply_markup=generate_rules()
    )


@router.callback_query(F.data == "pick_box")
async def pick_box(callback: CallbackQuery):
    text = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –±–æ–∫—Å—ã –¥–ª—è –∞—Ä–µ–Ω–¥—ã:\n\n"
    
    for box in BOXES:
        text += (
            f"üì¶ {box['name']}\n"
            f"   –†–∞–∑–º–µ—Ä: {box['size']} ({box['dimensions']})\n"
            f"   –¶–µ–Ω–∞: {box['price_per_month']} —Ä—É–±/–º–µ—Å\n"
            f"   –û–ø–∏—Å–∞–Ω–∏–µ: {box['description']}\n\n"
        )
    
    text += "–ß—Ç–æ–±—ã –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ '–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º'."
    
    await callback.message.answer(text)
    await callback.answer()


@router.callback_query(F.data == "contact_operator")
async def contact_operator(callback: CallbackQuery):
    tg_link = f"tg://user?id={MANAGER_TG_ID}"
    
    text = (
        "üìû <b>–°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</b>\n\n"
        f"–¢–µ–ª–µ—Ñ–æ–Ω: <a href=\"tel:{MANAGER_PHONE}\">{MANAGER_PHONE}</a>\n"
        f"Telegram: <a href=\"{tg_link}\">–ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É</a>\n\n"
        "–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –±–æ–∫—Å, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —É—Å–ª–æ–≤–∏—è–º —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑."
    )
    
    await callback.message.answer(text, parse_mode="HTML")
    await callback.answer()


@router.callback_query(F.data == "dispose_help")
async def dispose_help(callback: CallbackQuery):
    await callback.message.answer(
        "–î–ª—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –∫—Ä—É–ø–Ω–æ–≥–∞–±–∞—Ä–∏—Ç–Ω—ã—Ö –≤–µ—â–µ–π –º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –ø—Ä–∏–µ–º–∞ –º–µ—Ç–∞–ª–ª–æ–ª–æ–º–∞ –∏–ª–∏ –ñ–≠–ö (–≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞).\n"
        "–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –≤ –ø–æ–∏—Å–∫–µ ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã.",
        reply_markup=generate_prohibited_kb()
    )
    await callback.answer()